AWSTemplateFormatVersion: '2010-09-09'
Description: 'Enhanced CloudWatch Dashboard for Orders Service'

Parameters:
  Environment:
    Type: String
    Default: dev

Resources:
  EnhancedOrdersDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${Environment}-orders-enhanced-dashboard'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "OrdersService", "OrderCreated", { "stat": "Sum", "label": "Orders Created" } ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "Total Orders (24h)",
                "period": 86400
              }
            },
            {
              "type": "metric",
              "x": 6,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "OrdersService", "OrderValue", { "stat": "Sum", "label": "Total Revenue" } ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "Revenue (24h)",
                "period": 86400
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "OrdersService", "OrderValue", { "stat": "Average", "label": "Avg Order Value" } ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "Avg Order Value (24h)",
                "period": 86400
              }
            },
            {
              "type": "metric",
              "x": 18,
              "y": 0,
              "width": 6,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "OrdersService", "ValidationError", { "stat": "Sum", "label": "Errors" } ]
                ],
                "view": "singleValue",
                "region": "${AWS::Region}",
                "title": "Errors (24h)",
                "period": 86400
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "OrdersService", "OrderCreated", { "stat": "Sum", "period": 3600 } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Orders Created Per Hour",
                "period": 3600,
                "yAxis": {
                  "left": {
                    "label": "Count"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "OrdersService", "OrderValue", { "stat": "Sum", "period": 3600 } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Revenue Per Hour",
                "period": 3600,
                "yAxis": {
                  "left": {
                    "label": "Amount ($)"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/Lambda", "Duration", { "stat": "p50", "label": "p50" } ],
                  [ "...", { "stat": "p95", "label": "p95" } ],
                  [ "...", { "stat": "p99", "label": "p99" } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "API Latency Percentiles",
                "period": 300,
                "yAxis": {
                  "left": {
                    "label": "ms"
                  }
                }
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ { "expression": "(m1/(m1+m2))*100", "label": "Success Rate", "id": "e1" } ],
                  [ "AWS/Lambda", "Invocations", { "id": "m1", "visible": false } ],
                  [ ".", "Errors", { "id": "m2", "visible": false } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Success Rate %",
                "period": 300,
                "yAxis": {
                  "left": {
                    "min": 0,
                    "max": 100
                  }
                }
              }
            }
          ]
        }

Outputs:
  DashboardURL:
    Description: URL to Enhanced CloudWatch Dashboard
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${Environment}-orders-enhanced-dashboard'